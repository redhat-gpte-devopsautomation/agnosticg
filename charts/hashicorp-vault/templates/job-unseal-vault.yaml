apiVersion: batch/v1
kind: Job
metadata:
  name: unseal-volt
spec:
  template:
    spec:
      containers:
      - name: unseal-volt
        command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "=== Vault Initialization and Unsealing Job ==="
              echo "Waiting for vault-0 pod to be running..."
              
              # Wait for pod to exist and be running
              oc wait --for=condition=Ready=true -n vault pod/vault-0 --timeout=300s
              
              echo "Pod is ready, checking Vault status..."
              
              # Check if Vault is already initialized
              oc exec vault-0 --namespace=vault -- vault status -tls-skip-verify
              STATUS=$?
              
              if [ $STATUS -eq 0 ]; then
                echo "✓ Vault is already initialized and unsealed"
                exit 0
              fi
              
              if [ $STATUS -eq 2 ]; then
                # Vault is sealed - check if already initialized
                echo "Vault is sealed, checking if keys exist..."
                
                if oc exec vault-0 -n vault -- test -f /vault/data/vault-auto-unseal-keys.txt; then
                  echo "✓ Vault already initialized, unsealing with existing keys..."
                  oc exec vault-0 -n vault -- /bin/sh /vault/data/unseal.sh
                  exit 0
                fi
              fi
              
              # Vault is not initialized - initialize it
              echo "Initializing Vault for the first time..."
              oc exec vault-0 --namespace=vault --stdin --tty -- vault operator init -format=yaml > /tmp/vault-auto-unseal-keys.txt
              
              echo "Copying unseal keys to Vault pod..."
              cat /tmp/vault-auto-unseal-keys.txt | oc exec -i -n vault vault-0 -c vault "--" sh -c "cat > /vault/data/vault-auto-unseal-keys.txt"
              
              echo "Copying unseal script to Vault pod..."
              cat /vault-unseal-config/unseal.sh | oc exec -i -n vault vault-0 -c vault "--" sh -c "cat > /vault/data/unseal.sh"
              
              echo "Unsealing Vault..."
              oc exec vault-0 --namespace=vault --stdin --tty -- /bin/sh /vault/data/unseal.sh
              
              # Verify unsealing succeeded
              oc exec vault-0 --namespace=vault -- vault status -tls-skip-verify
              if [ $? -eq 0 ]; then
                echo "✓ Vault successfully initialized and unsealed"
              else
                echo "✗ Vault unseal verification failed"
                exit 1
              fi
        image: registry.redhat.io/openshift4/ose-cli:v4.7
        volumeMounts:
          - mountPath: /vault-unseal-config
            name: vault-unseal-config-volume
      restartPolicy: Never
      serviceAccount: vault
      volumes:
      - name: vault-unseal-config-volume
        configMap:
          name: vault-unseal-config
